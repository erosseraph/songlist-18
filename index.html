<script>
    // ==================== Supabase é…ç½® ====================
    const SUPABASE_URL = 'https://cnatjskljtjqolznoizb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuYXRqc2tsanRqcW9sem5vaXpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMDUzMzMsImV4cCI6MjA3ODg4MTMzM30.okHQXFBoLaMyR3wdgP-1W_Z1spqcb-ihC4Xf2gz1MgU';
    
    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // å…¨å±€å˜é‡
    let currentUser = null;
    let currentSongs = [];
    let playlist = [];
    let currentAudio = null;
    let isPlaying = false;
    let isSearchResultsView = false;
    let currentPlaylistPage = 1;
    const SONGS_PER_PAGE = 10;

    // æµ‹è¯•è¿æ¥
    async function testConnection() {
        try {
            const { data, error } = await supabase.from('users').select('count');
            if (error) throw error;
            console.log('âœ… Supabase è¿æ¥æˆåŠŸ');
            return true;
        } catch (error) {
            console.log('âŒ Supabase è¿æ¥å¤±è´¥:', error.message);
            showMessage('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
            return false;
        }
    }

    // ==================== æ ¸å¿ƒåŠŸèƒ½åˆå§‹åŒ– ====================
    function initializeApp() {
        console.log('ğŸš€ åˆå§‹åŒ–åº”ç”¨...');
        
        // åˆå§‹åŒ–é¡µé¢åˆ‡æ¢
        initializePageNavigation();
        
        // åˆå§‹åŒ–ä»·æ ¼é…å¥—æŒ‰é’®
        initializePricingButtons();
        
        // åˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿ
        initializeUserSystem();
        
        // åˆå§‹åŒ–ç‚¹æ­Œç³»ç»Ÿ
        initializeKaraokeSystem();
        
        // åˆå§‹åŒ–è®¢å•ç³»ç»Ÿ
        initializeOrderSystem();
        
        // åˆå§‹åŒ–ç®¡ç†åå°
        initializeAdminSystem();
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        checkUserLogin();
        
        // æµ‹è¯•è¿æ¥
        testConnection();
        
        console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
    }

    // ==================== é¡µé¢åˆ‡æ¢åŠŸèƒ½ ====================
    function initializePageNavigation() {
        console.log('ğŸ”§ åˆå§‹åŒ–é¡µé¢å¯¼èˆª...');
        
        document.getElementById('karaoke-nav').addEventListener('click', function() {
            showPage('karaoke');
            setActiveNav(this);
        });
        
        document.getElementById('pricing-nav').addEventListener('click', function() {
            showPage('pricing');
            setActiveNav(this);
        });
        
        document.getElementById('admin-nav').addEventListener('click', function() {
            showPage('admin');
            setActiveNav(this);
            loadOrders();
        });
    }
    
    function showPage(page) {
        console.log('ğŸ“„ åˆ‡æ¢åˆ°é¡µé¢:', page);
        document.getElementById('karaoke-page').style.display = page === 'karaoke' ? 'flex' : 'none';
        document.getElementById('pricing-page').style.display = page === 'pricing' : 'block' : 'none';
        document.getElementById('order-page').style.display = page === 'order' ? 'block' : 'none';
        document.getElementById('admin-page').style.display = page === 'admin' ? 'block' : 'none';
    }
    
    function setActiveNav(activeButton) {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }

    // ==================== ä»·æ ¼é…å¥—åŠŸèƒ½ ====================
    function initializePricingButtons() {
        console.log('ğŸ”§ åˆå§‹åŒ–ä»·æ ¼æŒ‰é’®...');
        
        document.querySelectorAll('.select-btn').forEach(button => {
            button.addEventListener('click', function() {
                const planName = this.dataset.plan;
                const minSongs = this.dataset.min;
                const maxSongs = this.dataset.max;
                const price = this.dataset.price;
                
                if (planName === 'è‡ªå®šä¹‰ç‰ˆ') {
                    alert(`æ‚¨é€‰æ‹©äº† ${planName}\nä»·æ ¼: RM${price}/æ¯é¦–\n\nè¯·é€šè¿‡ç”µè¯æˆ–é‚®ç®±è”ç³»æˆ‘ä»¬çš„å®¢æœå›¢é˜Ÿè¿›è¡Œå®šåˆ¶ã€‚`);
                } else {
                    alert(`æ‚¨é€‰æ‹©äº† ${planName} é…å¥—\næ­Œæ›²èŒƒå›´: ${minSongs} - ${maxSongs} é¦–\nä»·æ ¼: RM${price}\n\nè¯·å…ˆåˆ›å»ºæ­Œå•ï¼Œç„¶åæäº¤è®¢å•ã€‚`);
                }
            });
        });
    }

    // ==================== ç”¨æˆ·ç™»å½•åŠŸèƒ½ ====================
    function initializeUserSystem() {
        console.log('ğŸ”§ åˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿ...');
        
        const loginModal = document.getElementById('login-modal');
        const loginBtn = document.getElementById('login-btn');
        const closeLoginBtn = document.getElementById('close-login');
        const loginSubmitBtn = document.getElementById('login-submit');
        const phoneInput = document.getElementById('phone-input');
        const userInfo = document.getElementById('user-info');
        const userPhone = document.getElementById('user-phone');
        const logoutBtn = document.getElementById('logout-btn');
        
        // ç™»å½•ç›¸å…³äº‹ä»¶
        loginBtn.addEventListener('click', () => {
            loginModal.style.display = 'flex';
        });
        
        closeLoginBtn.addEventListener('click', () => {
            loginModal.style.display = 'none';
        });
        
        loginSubmitBtn.addEventListener('click', handleLogin);
        
        logoutBtn.addEventListener('click', handleLogout);
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', (e) => {
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });
    }
    
    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    function checkUserLogin() {
        const savedUser = localStorage.getItem('currentUser');
        const savedPhone = localStorage.getItem('userPhone');
        
        if (savedUser && savedPhone) {
            currentUser = savedUser;
            updateUserUI();
            loadUserPlaylist();
        }
    }
    
    // æ›´æ–°ç”¨æˆ·ç•Œé¢
    function updateUserUI() {
        const savedUser = localStorage.getItem('currentUser');
        const savedPhone = localStorage.getItem('userPhone');
        
        if (savedUser && savedPhone) {
            currentUser = savedUser;
            document.getElementById('user-phone').textContent = savedPhone;
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('login-btn').style.display = 'none';
        } else {
            currentUser = null;
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('login-btn').style.display = 'block';
        }
    }
    
    // å¤„ç†ç™»å½•
    async function handleLogin() {
        const phone = document.getElementById('phone-input').value.trim();
        
        // ç®€å•çš„é©¬æ¥è¥¿äºšç”µè¯å·ç éªŒè¯
        const malaysiaPhoneRegex = /^\+60[0-9]{8,10}$/;
        
        if (!malaysiaPhoneRegex.test(phone)) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é©¬æ¥è¥¿äºšç”µè¯å·ç ï¼ˆæ ¼å¼ï¼š+60xxxxxxxxï¼‰');
            return;
        }
        
        try {
            showMessage('ç™»å½•ä¸­...');
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
            const { data: user, error } = await supabase
                .from('users')
                .upsert({ 
                    phone: phone,
                    updated_at: new Date().toISOString()
                }, {
                    onConflict: 'phone',
                    ignoreDuplicates: false
                })
                .select()
                .single();
                
            if (error) {
                console.error('Supabase é”™è¯¯:', error);
                // å¦‚æœSupabaseå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼
                currentUser = 'local_' + Date.now();
            } else {
                currentUser = user.id;
            }
            
            localStorage.setItem('currentUser', currentUser);
            localStorage.setItem('userPhone', phone);
            
            updateUserUI();
            document.getElementById('login-modal').style.display = 'none';
            
            // åŠ è½½ç”¨æˆ·çš„æ­Œå•
            await loadUserPlaylist();
            
            showMessage(`æ¬¢è¿å›æ¥ï¼${phone}`);
            
        } catch (error) {
            console.error('ç™»å½•å¤±è´¥:', error);
            // ä½¿ç”¨æœ¬åœ°æ¨¡å¼
            currentUser = 'local_' + Date.now();
            localStorage.setItem('currentUser', currentUser);
            localStorage.setItem('userPhone', phone);
            updateUserUI();
            document.getElementById('login-modal').style.display = 'none';
            showMessage('ä½¿ç”¨æœ¬åœ°æ¨¡å¼ç™»å½•');
        }
    }
    
    // å¤„ç†é€€å‡º
    function handleLogout() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userPhone');
        updateUserUI();
        
        // æ¸…ç©ºå½“å‰æ­Œå•
        playlist = [];
        renderPlaylist();
        updatePlaylistCount();
        
        showMessage('å·²é€€å‡ºç™»å½•');
    }

    // ==================== ç‚¹æ­Œç³»ç»ŸåŠŸèƒ½ ====================
    function initializeKaraokeSystem() {
        console.log('ğŸ”§ åˆå§‹åŒ–ç‚¹æ­Œç³»ç»Ÿ...');
        
        setupEventListeners();
        updatePlaylistCount();
        loadChart('chinese-pop');
    }
    
    // ä¿®å¤çš„æ­Œæ›²æœç´¢åŠŸèƒ½ - ä½¿ç”¨å¯é çš„API
    async function searchMusic(term, limit = 50) {
        try {
            showLoading('æ­£åœ¨æœç´¢æ­Œæ›²...');
            
            // ä½¿ç”¨æ›´å¯é çš„éŸ³ä¹API
            const response = await fetch(`https://api.deezer.com/search?q=${encodeURIComponent(term)}&limit=${limit}`);
            
            if (!response.ok) {
                throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            }
            
            const data = await response.json();
            
            if (!data.data || data.data.length === 0) {
                showError('æœªæ‰¾åˆ°ç›¸å…³ç»“æœ');
                return generateMockSongs(term, limit);
            }
            
            // å¤„ç†è¿”å›çš„æ•°æ®
            return data.data.map(track => ({
                id: track.id || Math.random().toString(36).substr(2, 9),
                title: track.title || 'æœªçŸ¥æ­Œæ›²',
                artist: track.artist?.name || 'æœªçŸ¥æ­Œæ‰‹',
                album: track.album?.title || 'æœªçŸ¥ä¸“è¾‘',
                duration: track.duration * 1000,
                previewUrl: track.preview,
                artwork: track.album?.cover_medium
            }));
        } catch (error) {
            console.error('æœç´¢å¤±è´¥:', error);
            // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            return generateMockSongs(term, limit);
        }
    }
    
    // ç”Ÿæˆæ¨¡æ‹Ÿæ­Œæ›²æ•°æ®
    function generateMockSongs(query, limit) {
        const mockData = [
            { id: 1, title: 'å‘Šç™½æ°”çƒ', artist: 'å‘¨æ°ä¼¦', album: 'å‘¨æ°ä¼¦çš„åºŠè¾¹æ•…äº‹', duration: 215000, previewUrl: null },
            { id: 2, title: 'å…‰å¹´ä¹‹å¤–', artist: 'é‚“ç´«æ£‹', album: 'å…‰å¹´ä¹‹å¤–', duration: 235000, previewUrl: null },
            { id: 3, title: 'æ¼”å‘˜', artist: 'è–›ä¹‹è°¦', album: 'ç»…å£«', duration: 257000, previewUrl: null },
            { id: 4, title: 'å¹´å°‘æœ‰ä¸º', artist: 'æè£æµ©', album: 'è€³æœµ', duration: 244000, previewUrl: null },
            { id: 5, title: 'èµ·é£äº†', artist: 'ä¹°è¾£æ¤’ä¹Ÿç”¨åˆ¸', album: 'èµ·é£äº†', duration: 318000, previewUrl: null },
            { id: 6, title: 'ä½“é¢', artist: 'äºæ–‡æ–‡', album: 'ä½“é¢', duration: 287000, previewUrl: null },
            { id: 7, title: 'é£˜å‘åŒ—æ–¹', artist: 'é»„æ˜å¿—, ç‹åŠ›å®', album: 'äºšæ´²é€šè½¦', duration: 323000, previewUrl: null },
            { id: 8, title: 'è¯´æ•£å°±æ•£', artist: 'JC', album: 'è¯´æ•£å°±æ•£', duration: 258000, previewUrl: null },
            { id: 9, title: 'è¿½å…‰è€…', artist: 'å²‘å®å„¿', album: 'å¤è‡³æœªè‡³', duration: 236000, previewUrl: null },
            { id: 10, title: 'å²æœˆç¥å·', artist: 'é‡‘çŸå²', album: 'å²æœˆç¥å·', duration: 245000, previewUrl: null }
        ];
        
        // æ ¹æ®æŸ¥è¯¢è¯è¿‡æ»¤
        const filtered = mockData.filter(song => 
            song.title.toLowerCase().includes(query.toLowerCase()) ||
            song.artist.toLowerCase().includes(query.toLowerCase())
        );
        
        return filtered.slice(0, limit);
    }
    
    // åŠ è½½æ’è¡Œæ¦œ
    async function loadChart(category) {
        isSearchResultsView = false;
        let searchTerm = '';
        
        switch(category) {
            case 'chinese-pop':
                searchTerm = 'å‘¨æ°ä¼¦ é‚“ç´«æ£‹ è–›ä¹‹è°¦';
                break;
            case 'western-pop':
                searchTerm = 'taylor swift ed sheeran';
                break;
            case 'chinese-dj':
                searchTerm = 'ä¸­æ–‡ remix';
                break;
            case 'chinese-artists':
                renderArtistsList([
                    'å‘¨æ°ä¼¦', 'æ—ä¿Šæ°', 'é‚“ç´«æ£‹', 'è–›ä¹‹è°¦', 'æè£æµ©', 
                    'ç‹åŠ›å®', 'é™ˆå¥•è¿…', 'å¼ æƒ å¦¹', 'è”¡ä¾æ—', 'å­™ç‡•å§¿'
                ]);
                return;
            case 'western-artists':
                renderArtistsList([
                    'Taylor Swift', 'Ed Sheeran', 'Ariana Grande', 'Justin Bieber', 'Billie Eilish'
                ]);
                return;
        }
        
        currentSongs = await searchMusic(searchTerm, 30);
        renderSongs(currentSongs);
        
        // é«˜äº®é€‰ä¸­çš„æ’è¡Œæ¦œ
        document.querySelectorAll('.chart-category').forEach(chart => {
            chart.classList.remove('active');
        });
        document.querySelector(`[data-category="${category}"]`).classList.add('active');
    }
    
    // æ¸²æŸ“æ­Œæ‰‹åˆ—è¡¨
    function renderArtistsList(artists) {
        const songsContainer = document.getElementById('songs-container');
        songsContainer.innerHTML = '';
        
        artists.forEach(artist => {
            const artistElement = document.createElement('div');
            artistElement.className = 'song';
            artistElement.innerHTML = `
                <div class="song-info">
                    <div class="song-title">${artist}</div>
                    <div class="song-artist">æ­Œæ‰‹</div>
                </div>
                <div class="song-controls">
                    <button class="add-btn" data-artist="${artist}">æœç´¢</button>
                </div>
            `;
            songsContainer.appendChild(artistElement);
        });
    }
    
    // æ¸²æŸ“æ­Œæ›²åˆ—è¡¨
    function renderSongs(songs) {
        const songsContainer = document.getElementById('songs-container');
        songsContainer.innerHTML = '';
        
        if (songs.length === 0) {
            songsContainer.innerHTML = '<div class="empty-playlist">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
            return;
        }
        
        // å¦‚æœæ˜¯æœç´¢ç»“æœé¡µé¢ï¼Œæ·»åŠ è¿”å›æŒ‰é’®
        if (isSearchResultsView) {
            const backButton = document.createElement('button');
            backButton.className = 'back-btn';
            backButton.textContent = 'â† è¿”å›æ’è¡Œæ¦œ';
            backButton.addEventListener('click', () => {
                isSearchResultsView = false;
                loadChart('chinese-pop');
            });
            songsContainer.appendChild(backButton);
        }
        
        songs.forEach(song => {
            const songElement = document.createElement('div');
            songElement.className = 'song';
            songElement.innerHTML = `
                <div class="song-info">
                    <div class="song-title">${song.title}</div>
                    <div class="song-artist">${song.artist}</div>
                    <div class="song-album">${song.album}</div>
                </div>
                <div class="song-controls">
                    ${song.previewUrl ? `<button class="preview-btn" data-id="${song.id}" data-preview="${song.previewUrl}">â–¶ï¸</button>` : ''}
                    <button class="add-btn" data-id="${song.id}">+</button>
                </div>
            `;
            songsContainer.appendChild(songElement);
        });
    }
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        const chartsContainer = document.getElementById('charts-container');
        const songsContainer = document.getElementById('songs-container');
        const playlistContainer = document.getElementById('playlist-items');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const clearBtn = document.getElementById('clear-btn');
        const shareBtn = document.getElementById('share-btn');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        // æ’è¡Œæ¦œç‚¹å‡»äº‹ä»¶
        chartsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('chart-category')) {
                const category = e.target.dataset.category;
                loadChart(category);
            }
        });
        
        // æ·»åŠ æ­Œæ›²åˆ°æ­Œå•
        songsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-btn')) {
                const songId = e.target.dataset.id;
                const artist = e.target.dataset.artist;
                
                if (artist) {
                    performSearch(artist);
                } else if (songId) {
                    addSongToPlaylist(songId);
                }
            } else if (e.target.classList.contains('preview-btn')) {
                const songId = e.target.dataset.id;
                const previewUrl = e.target.dataset.preview;
                previewSong(songId, previewUrl);
            }
        });
        
        // ä»æ­Œå•ç§»é™¤æ­Œæ›²
        playlistContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) {
                const index = parseInt(e.target.dataset.index);
                removeSongFromPlaylist(index);
            }
        });
        
        // æœç´¢åŠŸèƒ½
        searchBtn.addEventListener('click', () => {
            const query = searchInput.value.trim();
            if (query) {
                performSearch(query);
            } else {
                showMessage('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
            }
        });
        
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                const query = searchInput.value.trim();
                if (query) {
                    performSearch(query);
                }
            }
        });
        
        // æ¸…ç©ºæ­Œå•
        clearBtn.addEventListener('click', clearPlaylist);
        
        // åˆ†äº«æ­Œå•
        shareBtn.addEventListener('click', sharePlaylist);
        
        // éŸ³é¢‘æ§åˆ¶
        playPauseBtn.addEventListener('click', togglePlayPause);
        stopBtn.addEventListener('click', stopAudio);
    }
    
    // æ‰§è¡Œæœç´¢
    async function performSearch(query) {
        isSearchResultsView = true;
        currentSongs = await searchMusic(query, 50);
        renderSongs(currentSongs);
    }
    
    // æ·»åŠ æ­Œæ›²åˆ°æ­Œå•
    function addSongToPlaylist(songId) {
        const song = currentSongs.find(s => s.id == songId);
        
        if (song) {
            // æ£€æŸ¥æ˜¯å¦å·²åœ¨æ­Œå•ä¸­
            if (!playlist.some(s => s.id == songId)) {
                playlist.push({...song});
                // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                currentPlaylistPage = 1;
                renderPlaylist();
                updatePlaylistCount();
                showMessage(`å·²æ·»åŠ  "${song.title}" åˆ°æ­Œå•`);
                
                // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨ä¿å­˜æ­Œå•
                if (currentUser) {
                    saveUserPlaylist();
                }
            } else {
                showMessage(`"${song.title}" å·²åœ¨æ­Œå•ä¸­`);
            }
        } else {
            showMessage('æ‰¾ä¸åˆ°è¯¥æ­Œæ›²ï¼Œè¯·é‡è¯•');
        }
    }
    
    // ä»æ­Œå•ç§»é™¤æ­Œæ›²
    function removeSongFromPlaylist(index) {
        if (index >= 0 && index < playlist.length) {
            const songTitle = playlist[index].title;
            playlist.splice(index, 1);
            
            // å¦‚æœåˆ é™¤æ­Œæ›²åå½“å‰é¡µæ²¡æœ‰æ­Œæ›²äº†ï¼Œåˆ™å›åˆ°ä¸Šä¸€é¡µ
            const currentPageStartIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
            if (playlist.length <= currentPageStartIndex && currentPlaylistPage > 1) {
                currentPlaylistPage--;
            }
            
            renderPlaylist();
            updatePlaylistCount();
            showMessage(`å·²ä»æ­Œå•ç§»é™¤ "${songTitle}"`);
            
            // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨ä¿å­˜æ­Œå•
            if (currentUser) {
                saveUserPlaylist();
            }
        }
    }
    
    // ä¿å­˜ç”¨æˆ·æ­Œå•åˆ° Supabase
    async function saveUserPlaylist() {
        if (!currentUser || currentUser.startsWith('local_')) return;
        
        try {
            const { error } = await supabase
                .from('playlists')
                .upsert({
                    user_id: currentUser,
                    songs: playlist,
                    song_count: playlist.length,
                    updated_at: new Date().toISOString()
                }, {
                    onConflict: 'user_id'
                });
                
            if (error) throw error;
            
            console.log('âœ… æ­Œå•ä¿å­˜æˆåŠŸ');
        } catch (error) {
            console.error('ä¿å­˜æ­Œå•å¤±è´¥:', error);
        }
    }
    
    // ä» Supabase åŠ è½½ç”¨æˆ·æ­Œå•
    async function loadUserPlaylist() {
        if (!currentUser || currentUser.startsWith('local_')) return;
        
        try {
            const { data, error } = await supabase
                .from('playlists')
                .select('songs, song_count')
                .eq('user_id', currentUser)
                .single();
                
            if (error && error.code !== 'PGRST116') throw error;
            
            if (data && data.songs) {
                playlist = data.songs;
                currentPlaylistPage = 1;
                renderPlaylist();
                updatePlaylistCount();
                showMessage('å·²åŠ è½½æ‚¨çš„æ­Œå•');
            }
        } catch (error) {
            console.error('åŠ è½½æ­Œå•å¤±è´¥:', error);
        }
    }
    
    // æ¸²æŸ“æ­Œå•
    function renderPlaylist() {
        const playlistContainer = document.getElementById('playlist-items');
        const playlistPagination = document.getElementById('playlist-pagination');
        
        playlistContainer.innerHTML = '';
        
        if (playlist.length === 0) {
            playlistContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©ºï¼Œè¯·ä»å·¦ä¾§æ·»åŠ æ­Œæ›²</div>';
            renderPlaylistPagination();
            return;
        }
        
        // è®¡ç®—å½“å‰é¡µçš„æ­Œæ›²
        const startIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
        const endIndex = Math.min(startIndex + SONGS_PER_PAGE, playlist.length);
        const currentSongs = playlist.slice(startIndex, endIndex);
        
        currentSongs.forEach((song, index) => {
            const globalIndex = startIndex + index;
            const playlistItem = document.createElement('div');
            playlistItem.className = 'playlist-item';
            playlistItem.draggable = true;
            playlistItem.dataset.index = globalIndex;
            playlistItem.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <div class="song-number">${globalIndex + 1}</div>
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                    </div>
                </div>
                <button class="remove-btn" data-index="${globalIndex}">Ã—</button>
            `;
            playlistContainer.appendChild(playlistItem);
        });
        
        renderPlaylistPagination();
    }
    
    // æ¸²æŸ“æ­Œå•åˆ†é¡µ
    function renderPlaylistPagination() {
        const playlistPagination = document.getElementById('playlist-pagination');
        playlistPagination.innerHTML = '';
        
        if (playlist.length <= SONGS_PER_PAGE) {
            return;
        }
        
        const totalPages = Math.ceil(playlist.length / SONGS_PER_PAGE);
        
        // ä¸Šä¸€é¡µæŒ‰é’®
        if (currentPlaylistPage > 1) {
            const prevButton = document.createElement('button');
            prevButton.textContent = 'ä¸Šä¸€é¡µ';
            prevButton.addEventListener('click', () => {
                currentPlaylistPage--;
                renderPlaylist();
            });
            playlistPagination.appendChild(prevButton);
        }
        
        // é¡µç æŒ‰é’®
        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.classList.toggle('active', i === currentPlaylistPage);
            pageButton.addEventListener('click', () => {
                currentPlaylistPage = i;
                renderPlaylist();
            });
            playlistPagination.appendChild(pageButton);
        }
        
        // ä¸‹ä¸€é¡µæŒ‰é’®
        if (currentPlaylistPage < totalPages) {
            const nextButton = document.createElement('button');
            nextButton.textContent = 'ä¸‹ä¸€é¡µ';
            nextButton.addEventListener('click', () => {
                currentPlaylistPage++;
                renderPlaylist();
            });
            playlistPagination.appendChild(nextButton);
        }
    }
    
    // æ›´æ–°æ­Œå•è®¡æ•°
    function updatePlaylistCount() {
        document.getElementById('playlist-count').textContent = `(${playlist.length})`;
    }
    
    // æ¸…ç©ºæ­Œå•
    function clearPlaylist() {
        if (playlist.length === 0) {
            showMessage('æ­Œå•å·²ç»æ˜¯ç©ºçš„');
            return;
        }
        
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ­Œå•å—ï¼Ÿ')) {
            playlist = [];
            currentPlaylistPage = 1;
            renderPlaylist();
            updatePlaylistCount();
            showMessage('æ­Œå•å·²æ¸…ç©º');
            
            if (currentUser) {
                saveUserPlaylist();
            }
        }
    }
    
    // åˆ†äº«æ­Œå• - è½¬è·³åˆ°è®¢å•é¡µé¢
    function sharePlaylist() {
        if (playlist.length === 0) {
            showMessage('æ­Œå•ä¸ºç©ºï¼Œæ— æ³•æäº¤è®¢å•');
            return;
        }
        
        if (!currentUser) {
            showMessage('è¯·å…ˆç™»å½•ä»¥ä¿å­˜å’Œæäº¤è®¢å•');
            document.getElementById('login-modal').style.display = 'flex';
            return;
        }
        
        showOrderPage();
    }
    
    // æ˜¾ç¤ºè®¢å•é¡µé¢
    function showOrderPage() {
        showPage('order');
        setActiveNav(null);
        
        // å¡«å……ç”¨æˆ·ä¿¡æ¯
        const savedPhone = localStorage.getItem('userPhone');
        if (savedPhone) {
            document.getElementById('customer-phone').value = savedPhone;
        }
        
        renderOrderPlaylistPreview();
        calculateAndDisplayPrice();
    }

    // ==================== éŸ³é¢‘æ’­æ”¾åŠŸèƒ½ ====================
    function previewSong(songId, previewUrl) {
        const song = currentSongs.find(s => s.id == songId);
        
        if (song && previewUrl) {
            // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            try {
                currentAudio = new Audio(previewUrl);
                const audioPlayer = document.getElementById('audio-player');
                const audioInfo = document.getElementById('audio-info');
                const playPauseBtn = document.getElementById('play-pause-btn');
                
                currentAudio.play().then(() => {
                    isPlaying = true;
                    playPauseBtn.textContent = "â¸ï¸";
                    audioPlayer.classList.remove('hidden');
                    audioInfo.textContent = `è¯•å¬: ${song.title} - ${song.artist}`;
                    showMessage(`å¼€å§‹è¯•å¬ "${song.title}"`);
                }).catch(error => {
                    console.error('æ’­æ”¾å¤±è´¥:', error);
                    showMessage('è¯•å¬æ’­æ”¾å¤±è´¥');
                });
                
                currentAudio.addEventListener('ended', () => {
                    stopAudio();
                    showMessage(`è¯•å¬ç»“æŸ: ${song.title}`);
                });
                
            } catch (error) {
                console.error('åˆ›å»ºéŸ³é¢‘å¤±è´¥:', error);
                showMessage('è¯•å¬åŠŸèƒ½æš‚ä¸å¯ç”¨');
            }
        } else {
            showMessage('è¯¥æ­Œæ›²æš‚æ— è¯•å¬åŠŸèƒ½');
        }
    }
    
    function togglePlayPause() {
        if (currentAudio) {
            const playPauseBtn = document.getElementById('play-pause-btn');
            if (isPlaying) {
                currentAudio.pause();
                playPauseBtn.textContent = "â–¶ï¸";
            } else {
                currentAudio.play().then(() => {
                    playPauseBtn.textContent = "â¸ï¸";
                });
            }
            isPlaying = !isPlaying;
        }
    }
    
    function stopAudio() {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            isPlaying = false;
            document.getElementById('play-pause-btn').textContent = "â–¶ï¸";
            document.getElementById('audio-player').classList.add('hidden');
        }
    }

    // ==================== è®¢å•åŠŸèƒ½ ====================
    function initializeOrderSystem() {
        console.log('ğŸ”§ åˆå§‹åŒ–è®¢å•ç³»ç»Ÿ...');
        
        document.getElementById('customer-state').addEventListener('change', calculateAndDisplayPrice);
        document.getElementById('cancel-order').addEventListener('click', cancelOrder);
        document.getElementById('submit-order').addEventListener('click', submitOrder);
    }
    
    function cancelOrder() {
        showPage('karaoke');
        setActiveNav(document.getElementById('karaoke-nav'));
    }
    
    function submitOrder() {
        const name = document.getElementById('customer-name').value.trim();
        const phone = document.getElementById('customer-phone').value.trim();
        const address = document.getElementById('customer-address').value.trim();
        const state = document.getElementById('customer-state').value;
        
        if (!name || !phone || !address || !state) {
            alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
            return;
        }
        
        const malaysiaPhoneRegex = /^\+60[0-9]{8,10}$/;
        if (!malaysiaPhoneRegex.test(phone)) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é©¬æ¥è¥¿äºšç”µè¯å·ç ï¼ˆæ ¼å¼ï¼š+60xxxxxxxxï¼‰');
            return;
        }
        
        createOrder(name, phone, address, state);
    }
    
    // æ¸²æŸ“è®¢å•é¡µé¢çš„æ­Œå•é¢„è§ˆ
    function renderOrderPlaylistPreview() {
        const previewContainer = document.getElementById('order-playlist-preview');
        previewContainer.innerHTML = '';
        
        if (playlist.length === 0) {
            previewContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©º</div>';
            return;
        }
        
        const displaySongs = playlist.slice(0, 10);
        
        displaySongs.forEach((song, index) => {
            const songElement = document.createElement('div');
            songElement.className = 'playlist-preview-item';
            songElement.textContent = `${index + 1}. ${song.title} - ${song.artist}`;
            previewContainer.appendChild(songElement);
        });
        
        if (playlist.length > 10) {
            const moreElement = document.createElement('div');
            moreElement.className = 'playlist-preview-item';
            moreElement.textContent = `... è¿˜æœ‰ ${playlist.length - 10} é¦–æ­Œæ›²`;
            moreElement.style.fontStyle = 'italic';
            previewContainer.appendChild(moreElement);
        }
        
        const countElement = document.createElement('div');
        countElement.className = 'playlist-preview-item';
        countElement.textContent = `å…±è®¡ ${playlist.length} é¦–æ­Œæ›²`;
        countElement.style.fontWeight = 'bold';
        countElement.style.borderTop = '1px solid rgba(255,255,255,0.2)';
        countElement.style.paddingTop = '10px';
        countElement.style.marginTop = '10px';
        previewContainer.appendChild(countElement);
    }
    
    // è®¡ç®—å¹¶æ˜¾ç¤ºä»·æ ¼
    function calculateAndDisplayPrice() {
        const songCount = playlist.length;
        const state = document.getElementById('customer-state').value;
        
        let packageName, packagePrice;
        if (songCount <= 20) {
            packageName = "åŸºç¡€ç‰ˆ"; packagePrice = 29;
        } else if (songCount <= 50) {
            packageName = "æ ‡å‡†ç‰ˆ"; packagePrice = 49;
        } else if (songCount <= 100) {
            packageName = "è¿›é˜¶ç‰ˆ"; packagePrice = 69;
        } else if (songCount <= 200) {
            packageName = "è±ªåç‰ˆ"; packagePrice = 89;
        } else if (songCount <= 300) {
            packageName = "ä¸“ä¸šç‰ˆ"; packagePrice = 109;
        } else if (songCount <= 400) {
            packageName = "æ——èˆ°ç‰ˆ"; packagePrice = 129;
        } else if (songCount <= 500) {
            packageName = "è‡³å°Šç‰ˆ"; packagePrice = 159;
        } else {
            packageName = "è‡ªå®šä¹‰ç‰ˆ"; packagePrice = songCount * 0.3;
        }
        
        let shippingFee = state === 'east' ? 8 : 0;
        const totalPrice = packagePrice + shippingFee;
        
        const priceSummary = document.getElementById('price-summary');
        priceSummary.innerHTML = `
            <div class="price-row">
                <span>æ¨èé…å¥—ï¼š</span>
                <span>${packageName} (${songCount}é¦–)</span>
            </div>
            <div class="price-row">
                <span>é…å¥—ä»·æ ¼ï¼š</span>
                <span>RM${packagePrice.toFixed(2)}</span>
            </div>
            <div class="price-row">
                <span>é‚®è´¹ï¼š</span>
                <span>${shippingFee === 0 ? 'å…è´¹' : `RM${shippingFee.toFixed(2)}`}</span>
            </div>
            <div class="price-row total-price">
                <span>æ€»è´¹ç”¨ï¼š</span>
                <span>RM${totalPrice.toFixed(2)}</span>
            </div>
        `;
    }
    
    // åˆ›å»ºè®¢å•
    async function createOrder(name, phone, address, state) {
        const songCount = playlist.length;
        
        if (songCount === 0) {
            alert('æ­Œå•ä¸ºç©ºï¼Œæ— æ³•åˆ›å»ºè®¢å•');
            return;
        }
        
        let packageName, packagePrice;
        if (songCount <= 20) {
            packageName = "åŸºç¡€ç‰ˆ"; packagePrice = 29;
        } else if (songCount <= 50) {
            packageName = "æ ‡å‡†ç‰ˆ"; packagePrice = 49;
        } else if (songCount <= 100) {
            packageName = "è¿›é˜¶ç‰ˆ"; packagePrice = 69;
        } else if (songCount <= 200) {
            packageName = "è±ªåç‰ˆ"; packagePrice = 89;
        } else if (songCount <= 300) {
            packageName = "ä¸“ä¸šç‰ˆ"; packagePrice = 109;
        } else if (songCount <= 400) {
            packageName = "æ——èˆ°ç‰ˆ"; packagePrice = 129;
        } else if (songCount <= 500) {
            packageName = "è‡³å°Šç‰ˆ"; packagePrice = 159;
        } else {
            packageName = "è‡ªå®šä¹‰ç‰ˆ"; packagePrice = songCount * 0.3;
        }
        
        let shippingFee = state === 'east' ? 8 : 0;
        const totalPrice = packagePrice + shippingFee;
        const orderNumber = 'KTV' + Date.now();
        
        try {
            const { data, error } = await supabase
                .from('orders')
                .insert({
                    order_number: orderNumber,
                    user_id: currentUser,
                    customer_name: name,
                    customer_phone: phone,
                    customer_address: address,
                    state: state,
                    songs: playlist,
                    song_count: songCount,
                    package_name: packageName,
                    package_price: packagePrice,
                    shipping_fee: shippingFee,
                    total_price: totalPrice,
                    status: 'pending',
                    notes: 'åœ¨çº¿è®¢å•'
                })
                .select();
                
            if (error) throw error;
            
            alert(`ğŸ‰ è®¢å•æäº¤æˆåŠŸï¼\n\nè®¢å•ç¼–å·: ${orderNumber}\né…å¥—: ${packageName}\næ­Œæ›²æ•°é‡: ${songCount} é¦–\næ€»è´¹ç”¨: RM${totalPrice.toFixed(2)}\n\næˆ‘ä»¬çš„å®¢æœå°†åœ¨24å°æ—¶å†…è”ç³»æ‚¨ç¡®è®¤è®¢å•è¯¦æƒ…ã€‚`);
            
            playlist = [];
            renderPlaylist();
            updatePlaylistCount();
            await saveUserPlaylist();
            
            showPage('karaoke');
            setActiveNav(document.getElementById('karaoke-nav'));
            
        } catch (error) {
            console.error('è®¢å•æäº¤å¤±è´¥:', error);
            showMessage('è®¢å•æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœ');
        }
    }

    // ==================== ç®¡ç†åå°åŠŸèƒ½ ====================
    function initializeAdminSystem() {
        console.log('ğŸ”§ åˆå§‹åŒ–ç®¡ç†åå°...');
        
        document.getElementById('refresh-orders').addEventListener('click', loadOrders);
    }
    
    // åŠ è½½è®¢å•åˆ—è¡¨
    async function loadOrders() {
        try {
            const { data: orders, error } = await supabase
                .from('orders')
                .select('*')
                .order('created_at', { ascending: false });
                
            if (error) throw error;
            
            renderOrders(orders);
        } catch (error) {
            console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
            showMessage('åŠ è½½è®¢å•å¤±è´¥');
        }
    }
    
    // æ¸²æŸ“è®¢å•åˆ—è¡¨
    function renderOrders(orders) {
        const tbody = document.getElementById('orders-tbody');
        tbody.innerHTML = '';
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">æš‚æ— è®¢å•</td></tr>';
            return;
        }
        
        orders.forEach(order => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${order.order_number}</td>
                <td>${order.customer_name}</td>
                <td>${order.customer_phone}</td>
                <td>${order.song_count}</td>
                <td>${order.package_name}</td>
                <td>RM${order.total_price}</td>
                <td class="status-${order.status}">${getStatusText(order.status)}</td>
                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="view-order" data-id="${order.id}">æŸ¥çœ‹</button>
                    <button class="update-status" data-id="${order.id}">æ›´æ–°çŠ¶æ€</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.querySelectorAll('.view-order').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.id;
                viewOrderDetails(orderId);
            });
        });
        
        document.querySelectorAll('.update-status').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.id;
                updateOrderStatus(orderId);
            });
        });
    }
    
    function getStatusText(status) {
        const statusMap = {
            'pending': 'å¾…ç¡®è®¤',
            'confirmed': 'å·²ç¡®è®¤', 
            'completed': 'å·²å®Œæˆ'
        };
        return statusMap[status] || status;
    }
    
    async function viewOrderDetails(orderId) {
        try {
            const { data: order, error } = await supabase
                .from('orders')
                .select('*')
                .eq('id', orderId)
                .single();
                
            if (error) throw error;
            
            let songsList = '';
            if (order.songs && order.songs.length > 0) {
                songsList = order.songs.map((song, index) => 
                    `${index + 1}. ${song.title} - ${song.artist}`
                ).join('\n');
            }
            
            alert(`è®¢å•è¯¦æƒ…ï¼š
è®¢å•ç¼–å·: ${order.order_number}
å®¢æˆ·å§“å: ${order.customer_name}
ç”µè¯å·ç : ${order.customer_phone}
æ”¶è´§åœ°å€: ${order.customer_address}
å·å±: ${order.state === 'west' ? 'è¥¿é©¬' : 'ä¸œé©¬'}
é…å¥—: ${order.package_name}
æ­Œæ›²æ•°é‡: ${order.song_count}
æ€»è´¹ç”¨: RM${order.total_price}
çŠ¶æ€: ${getStatusText(order.status)}
ä¸‹å•æ—¶é—´: ${new Date(order.created_at).toLocaleString()}

æ­Œæ›²åˆ—è¡¨:
${songsList || 'æ— æ­Œæ›²ä¿¡æ¯'}`);
        } catch (error) {
            console.error('æŸ¥çœ‹è®¢å•è¯¦æƒ…å¤±è´¥:', error);
            showMessage('æŸ¥çœ‹è®¢å•è¯¦æƒ…å¤±è´¥');
        }
    }
    
    async function updateOrderStatus(orderId) {
        const newStatus = prompt('è¯·è¾“å…¥æ–°çš„è®¢å•çŠ¶æ€ (pending-å¾…ç¡®è®¤, confirmed-å·²ç¡®è®¤, completed-å·²å®Œæˆ):');
        
        if (newStatus && ['pending', 'confirmed', 'completed'].includes(newStatus)) {
            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('id', orderId);
                    
                if (error) throw error;
                
                showMessage('è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ');
                loadOrders();
            } catch (error) {
                console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
                showMessage('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥');
            }
        } else if (newStatus) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„çŠ¶æ€: pending, confirmed æˆ– completed');
        }
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    function showMessage(message) {
        const messageEl = document.createElement('div');
        messageEl.textContent = message;
        messageEl.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            z-index: 1000;
            transition: all 0.3s;
        `;
        
        document.body.appendChild(messageEl);
        
        setTimeout(() => {
            messageEl.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(messageEl)) {
                    document.body.removeChild(messageEl);
                }
            }, 300);
        }, 3000);
    }
    
    function showLoading(message) {
        const songsContainer = document.getElementById('songs-container');
        songsContainer.innerHTML = `<div class="loading">${message}</div>`;
    }
    
    function showError(message) {
        const songsContainer = document.getElementById('songs-container');
        songsContainer.innerHTML = `<div class="error">${message}</div>`;
    }

    // ==================== åº”ç”¨å¯åŠ¨ ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ“± DOMåŠ è½½å®Œæˆï¼Œå¯åŠ¨åº”ç”¨...');
        initializeApp();
    });
</script>